---
- name: Dump mysql database
  hosts: all
  remote_user:  "{{ user }}"
  vars:
    ansible_python_interpreter: /usr/bin/python3 # Eviter les warnings
    ansible_winrm_server_cert_validation: ignore # avoid warning and have to be here
    dump_path: "/home/{{ user }}/{{ application }}database.sql"
  tasks:

  - name: Include password file
    include_vars: "{{ playbooks_directory_path }}/variables/passwords.yml"

  - name: Dump database
    mysql_db:
      state: dump
      name: "{{ database_name }}"
      login_user: "{{ database_user }}"
      login_password: "{{ vault_database_password }}"
      target: "{{ dump_path }}"

  - name: Copy file from remote to host
    fetch:
      src: "{{ dump_path }}"
      dest: "{{ path }}/"
      flat: yes

  - name: Delete remote archive
    file:
      path: "{{ dump_path }}"
      state: absent
